---
title:  "JPA & Hibernate Proxy"

categories:
  - jpa
tags:
  - jpa
  - study
  - proxy
last_modified_at: 2021-05-06T00:40:00-00:00
---

# JPA Proxy
RDB ì™€ ë‹¤ë¥´ê²Œ javaì—ì„œëŠ” ì°¸ì¡°ë¥¼ í†µí•´ ê°ì²´ì˜ ì£¼ì†Œê°’ì„ ê°€ì§€ê³  ì¼ëŒ€ë‹¤ì˜ ê²½ìš° Listë¥¼ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.   
Entityì¡°íšŒ í•  ë•Œ ëª¨ë‘ ë‹¤ ê°€ì ¸ì™€ì•¼ í•œë‹¤ë©´ ì„±ëŠ¥ì ì¸ ì´ìŠˆê°€ ë‚˜ì˜¬ ìˆ˜ë°–ì— ì—†ë‹¤.   
ë”°ë¼ì„œ JPAì—ì„œëŠ” ì—°ê´€ëœ ê°ì²´ë“¤ì„ ëª¨ë‘ ì²˜ìŒë¶€í„° ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” ì‹œì ì— ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.   
ì´ì™€ ê´€ë ¨ ëœ ê¸°ìˆ ì´ í”„ë¡ì‹œ ì¸ë°, ì‚¬ìš©ì‹œì ì— ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¡°íšŒí•˜ëŠ”ê±¸ ì§€ì—°ë¡œë”© (LAZY)ì´ê³  ì²˜ìŒ ì¡°íšŒí•  ë•Œ ì—°ê´€ëœ ê°ì²´ê¹Œì§€ í•¨ê»˜ ì¡°íšŒí•˜ëŠ”ê²ƒì„ ì¦‰ì‹œë¡œë”© (EAGER)ë¼ê³  í•œë‹¤.   
   
Memberì™€ Orderë¡œ í™•ì¸í•´ë³´ì.
```java
@Entity
public class Member {
    @Id @GeneratedValue
    private Long id;

    private String name;

    @OneToMany(mappedBy = "member", cascade = CascadeType.ALL, orphanRemoval = true)
    private Set<Orders> orders = new HashSet<>();

    // ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì†Œë“œ
    public void addOrder(Orders orderB) {
        this.orders.add(orderB);
        orderB.setMember(this);
    }
    â€¢â€¢â€¢ //getter setter
}
@Entity
public class Orders {
    @Id @GeneratedValue
    private Long id;

    private LocalDateTime orderDate;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "MEMBER_ID")
    private Member member;
    
    â€¢â€¢â€¢ //getter setter
}
```
ManyToOne, OneToOneì€ ê¸°ë³¸ Fetch ì „ëµì´ EAGERì´ì–´ì„œ í•­ìƒ Joinì„ í•˜ì§€ë§Œ ì„±ëŠ¥ìƒì˜ ì´ìŠˆë¡œ LAZYí•˜ê¸°ë¥¼ ê¶Œì¥í•œë‹¤.   
LAZYëŠ” ì§€ì—°ë¡œë”©ìœ¼ë¡œ í•´ë‹¹ ê°ì²´ì˜ ì‹¤ì œ ì‚¬ìš© ì‹œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°ì²´ë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤ëŠ” ëœ»ì´ë‹¤.   
ì´ ì§€ì—°ë¡œë”©ì„ JPAì—ì„œëŠ” ì´ê²ƒì„ ì–´ë–»ê²Œ êµ¬í˜„í• ê¹Œ? ë‹µì€ Proxyì´ë‹¤.   
![proxy]({{ site.baseurl }}/assets/images/study/proxy.png)   
í•´ë‹¹ ê·¸ë¦¼ì²˜ëŸ¼ JPA ì—ì„œëŠ” Orderë¥¼ í˜¸ì¶œí•  ë•Œ ì•ˆì— Member ëŒ€ì‹ ê°’ì— Proxyë¥¼ ë„£ì–´ ë†“ëŠ”ë‹¤.   
order.getMember() ê¹Œì§€ëŠ” ì‹¤ì œ Member ê°ì²´ ëŒ€ì‹  Proxyê°€ ë“¤ì–´ìˆë‹¤ê°€ Member ê°ì²´ ì‚¬ìš©ì‹œì ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì¡°íšŒí•œë‹¤.   
ex)   
```java
Orders order1 = new Orders(LocalDateTime.now(), Status.PREPARE);
em.persist(order1);

Member member = new Member();
member.addOrder(order1);
em.persist(member);

em.flush();
em.clear();

Orders orders = em.find(Orders.class, order1.getId());

System.out.println("orders = " + orders.getClass().getName());
System.out.println("orders.getMember() = " + orders.getMember().getClass().getName());
```
em.findë¡œ Orderê°ì²´ë¥¼ ë¶ˆë €ì„ ë•Œ select ì¿¼ë¦¬ê°€ ë‚˜ê°”ì„ ê²ƒì´ë‹¤. Fetch ì „ëµì´ LAZYì´ê¸° ë•Œë¬¸ì— ì´ ë•Œ Memberì™€ joinì€ í•˜ì§€ ì•ŠëŠ”ë‹¤.   
ì‹¤ì œë¡œ Classë¥¼ í™•ì¸í•´ë³´ë©´ ì´ë ‡ê²Œ ë‚˜ì˜¨ë‹¤.   

ğŸ’»console
```markdown
orders = com.longlong.jpastudy.vo.Orders   
orders.getMember() = com.longlong.jpastudy.vo.Member$HibernateProxy$54qYULum
```   

Orderì—ì„œ Memberë¥¼ joiní•˜ì§€ ì•Šì•˜ìœ¼ë‹ˆ Proxyë¡œ ë‘˜ëŸ¬ì‹¼ ê°ì²´ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì´ë‹¤.    
orders.getMember().getName() ì²˜ëŸ¼ memberê°€ ì‹¤ì œë¡œ ì‚¬ìš©í•  ë•Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ memberë¥¼ ì°¾ì•„ì˜¨ë‹¤.   
(Hibernateì—ì„œëŠ” Hibernate.initialize(entity) ë¥¼ í†µí•´ ì´ˆê¸°í™”ë¥¼ ì§€ì›í•œë‹¤.)   

Jpaì—ì„œëŠ” ì»¬ë ‰ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì²˜ëŸ¼ == (ì£¼ì†Œê°’) ë¹„êµë„ í—ˆìš©í•˜ë¯€ë¡œ ì²˜ìŒì— í”„ë¡ì‹œ í˜¸ì¶œí•œ íŠœí”Œê³¼ ê°™ì€ íŠœí”Œì„ ë¶ˆëŸ¬ì˜¤ë©´ ê°™ì€ instanceë¡œ ë¶ˆëŸ¬ì™€ì§„ë‹¤.   
ex) 
```java
Orders orders = em.find(Orders.class, order1.getId());
final Member proxyMember = orders.getMember(); // í”„ë¡ì‹œ
final Member findMember = em.find(Member.class, member.getId()); // ì´ë¯¸ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìˆê¸° ë•Œë¬¸ì— í”„ë¡ì‹œ í˜¸ì¶œ

System.out.println("proxyMember = " + proxyMember.getClass().getName());
System.out.println("findMember = " + findMember.getClass().getName());
System.out.println("proxyMember == findMember : " + (findMember == proxyMember));
```
ğŸ’»console
```markdown
proxyMember = com.longlong.jpastudy.vo.Member$HibernateProxy$C2SQ7AEK
findMember = com.longlong.jpastudy.vo.Member$HibernateProxy$C2SQ7AEK
proxyMember == findMember : true
```
ì—¬ê¸°ì„œ findMemberì™€ ordersì˜ ìˆœì„œë§Œ ë°”ê¾¸ë©´ ë‘˜ ë‹¤ Memberê°ì²´ í˜¸ì¶œì´ ëœë‹¤.   
```java
â€¢â€¢â€¢
final Member findMember = em.find(Member.class, member.getId());
Orders orders = em.find(Orders.class, order1.getId());
final Member proxyMember = orders.getMember(); // í”„ë¡ì‹œ ì¼ê¹Œ??
â€¢â€¢â€¢
```
ğŸ’»console
```markdown
proxyMember = com.longlong.jpastudy.vo.Member
findMember = com.longlong.jpastudy.vo.Member
proxyMember == findMember : true
```
ì´ë ‡ê²Œ JPAì—ì„œëŠ” == ë¹„êµë¥¼ ì§€ì›í•œë‹¤.   

## LazyInitializationException
JPAë¥¼ ì˜ ì•Œì§€ ëª»í•˜ê³  ì‚¬ìš©í•˜ë©´ ì •ë§ ë§ì´ ë§Œë‚˜ëŠ” LazyInitializationExceptionì´ë‹¤.   
ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—†ëŠ” í”„ë¡ì‹œ ê°ì²´ë¥¼ Initialize í•  ë•Œ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.   
ex)   
```java
Orders orders = em.find(Orders.class, order1.getId());
final Member proxyMember = orders.getMember(); // í”„ë¡ì‹œ

System.out.println("proxyMember = " + proxyMember.getClass().getName());
em.detach(proxyMember);
//LazyInitializationException ì—ëŸ¬ ë°œìƒ System.out.println("proxyMember address = " + proxyMember.getAddress());
```

ğŸ‘ê²°ë¡  :   
1. ê°™ì€ sessionê³¼ thread
2. ì—”í‹°í‹°ê°€ ì˜ì†ìƒíƒœ
3. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì•ˆì— í”„ë¡ì‹œ ê°ì²´ê°€ ìˆì–´ì•¼ ì •ìƒ ì‘ë™í•œë‹¤.  

## Hibernate Proxy
[ê³µì‹ë¬¸ì„œ : https://docs.jboss.org/hibernate/orm/5.2/javadocs/org/hibernate/proxy/package-summary.html](https://docs.jboss.org/hibernate/orm/5.2/javadocs/org/hibernate/proxy/package-summary.html)   
HibernateëŠ” Proxyë¥¼ ì–´ë–»ê²Œ êµ¬í˜„í•˜ëŠ”ì§€ ìì„¸íˆ ì•Œì•„ë³´ê² ë‹¤.    
Hibernate ProxyëŠ” Entityë¥¼ ê°ì‹¸ê³  ì ì ˆí•œ ì‹œì ì— Initialize í•˜ì—¬ Entity ì •ë³´ë¥¼ ì„¤ì •í•˜ê³  getImplementationë¡œ Entityì— ì ‘ê·¼ í•  ìˆ˜ ìˆë‹¤.   
Hibernateì˜ ì¶”ìƒí´ë˜ìŠ¤ì¸ AbstractLazyInitializerë¥¼ ë³´ì.
```java
public abstract class AbstractLazyInitializer implements LazyInitializer {
    â€¢â€¢â€¢
    private String entityName;
    private Serializable id;
    private Object target;
    private boolean initialized;
    private boolean readOnly;
    private boolean unwrap;
    private transient SharedSessionContractImplementor session;
    private Boolean readOnlyBeforeAttachedToSession;
    private String sessionFactoryUuid;
    private boolean allowLoadOutsideTransaction;
    â€¢â€¢â€¢
```
entityNameê³¼ id(key) ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©° ì´ˆê¸° targetì€ nullì´ë‹¤. targetì •ë³´ë¥¼ ìš”ì²­í•˜ëŠ” ì‹œì ì— session.immediateLoadë¥¼ í•˜ì—¬ targetì— entityë¥¼ ì±„ì›Œ ë„£ëŠ”ë‹¤.   
ê·¸ë°–ì— readOnly, session, ì†ì„± ë“±ì€ ì´ˆê¸° entityManagerì—ì„œ ì„¤ì •í•´ì£¼ë©° ì›í•˜ëŠ” ëŒ€ë¡œ ë³€ê²½ ê°€ëŠ¥í•˜ì§€ë§Œ readOnly=falseì¸ Immutable Object ê°™ì€ ë…¼ë¦¬ì ì¸ í—›ì ì´ ìƒê¸°ë©´ Exceptionì´ ë˜ë¯€ë¡œ ì¡°ì‹¬íˆ ì‚¬ìš© í•´ì•¼í•œë‹¤.    

Hibernateì—ì„œ ê°ì²´ë¥¼ ê°€ì ¸ì˜¬ ë•ŒëŠ” ì´ì „ì— í”„ë¡ì‹œë¡œ ê°€ì ¸ì™”ìœ¼ë©´ í”„ë¡ì‹œë¡œ ì•„ë‹ˆë©´ Entityë¡œ ë¦¬í„´í•´ì¤€ë‹¤. ( == ë¹„êµë¥¼ ìœ„í•´)   
```java
//HibernateProxyHelper.class
public static Class getClassWithoutInitializingProxy(Object object) {
    if (object instanceof HibernateProxy) {
        HibernateProxy proxy = (HibernateProxy)object;
        LazyInitializer li = proxy.getHibernateLazyInitializer();
        return li.getPersistentClass();
    } else {
        // non proxy!!!
        return object.getClass();
    }
}
```

**ğŸ‘Tip:** JPA í‘œì¤€ ìŠ¤í™ì€ ì•„ë‹ˆì§€ë§Œ hibernateì—ëŠ” Hibernate.initialize(entity)ë¡œ ì´ˆê¸°í™”í•˜ê³  Hibernate.unproxy(entity)ë¼ëŠ” í”„ë¡ì‹œ í•´ì œ methodê°€ ìˆë‹¤.
{: .notice--warning}   

Hibernate.initialize
```java
// ë°”ì´íŠ¸ ë‹¨ê³„ì—ì„œ initializeë„ ì§€ì›í•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” ë„˜ì–´ê°€ê² ë‹¤.
//Hibernate.class
(Hibernate) proxy.getHibernateLazyInitializer().initialize()
//AbstractLazyInitializer.class
this.target = session.immediateLoad(this.entityName, this.id);
this.initialized = true;
this.checkTargetState(session); // targetì´ ì—†ì„ ë•Œ EntityNotFoundException ì²˜ë¦¬ ìœ„í•´
```

Hibernate.unproxy   
```java
Orders orders = em.find(Orders.class, order1.getId());
final Member findMember = orders.getMember();
final Member unproxyMember = Hibernate.unproxy(findMember, Member.class);

System.out.println("orders = " + orders.getClass().getName());
System.out.println("findMember = " + findMember.getClass().getName());
System.out.println("unproxyMember = " + unproxyMember.getClass().getName());
System.out.println("findMember == unproxyMember : " + (findMember == unproxyMember));
```
ğŸ’»console
```markdown
orders = com.longlong.jpastudy.vo.Orders
findMember = com.longlong.jpastudy.vo.Member$HibernateProxy$B6iuL2t5
unproxyMember = com.longlong.jpastudy.vo.Member
findMember == unproxyMember : false
```

unproxyì˜ ë™ì‘ê³¼ì •ì€ LazyInitializerì—ì„œ ì´ˆê¸°í™” í›„ targetì„ ë¶ˆëŸ¬ì˜¨ë‹¤.
```java
//Hibernate.class
public static Object unproxy(Object proxy) {
    if (proxy instanceof HibernateProxy) {
        HibernateProxy hibernateProxy = (HibernateProxy)proxy;
        LazyInitializer initializer = hibernateProxy.getHibernateLazyInitializer();
        return initializer.getImplementation();
    } else {
        return proxy;
    }
}
//AbstractLazyInitializer.class
public final Object getImplementation() {
    this.initialize();
    return this.target;
}
```



